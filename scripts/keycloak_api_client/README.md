# Keycloak API Client Creator

## üìù Description

This script is designed to automate API client creation in Keycloak with proper scope and role assignments for service-to-service authentication.

**Script Purpose:**
- Automatic API client creation in Keycloak with "api-" prefix
- Assigning "codemie" client scope for proper authorization
- Assigning "developer" role to client's service account
- Configuring service account user details and attributes
- Supporting both new client creation and existing client updates

## üîß Prerequisites

Before using the script, you need to prepare Keycloak:

### 1. Creating Service User `codemie_provisioner`

1. Log in to Keycloak Admin Console
2. Select "Master" realm in the left upper corner
3. Navigate to Users ‚Üí Add user
4. Create user with username `codemie_provisioner`
5. Set password in Credentials section (disable Temporary)
6. Assign the following role mappings:

   Steps for user creation:
   1. Select "Master" realm in the left upper corner of keycloak page
   2. Select Users tab
   3. Click "Add user" button
   4. Set username "codemie_provisioner"
   5. Click on created user and choose "Credentials" tab
   6. Set password and disable temporary radio button
   7. Click "Role mapping" tab and click "Assign role" button
   8. Select filter by clients and add mappings:

      ```
      default-roles-master
      codemie-prod-realm manage-events
      codemie-prod-realm view-events
      codemie-prod-realm query-clients
      codemie-prod-realm manage-users
      codemie-prod-realm view-clients
      codemie-prod-realm manage-clients
      codemie-prod-realm view-users
      codemie-prod-realm create-client
      codemie-prod-realm manage-realm
      codemie-prod-realm manage-identity-providers
      codemie-prod-realm impersonation
      codemie-prod-realm view-authorization
      codemie-prod-realm query-groups
      codemie-prod-realm view-identity-providers
      codemie-prod-realm query-realms
      codemie-prod-realm view-realm
      codemie-prod-realm query-users
      codemie-prod-realm manage-authorization
      ```

### 2. Realm Configuration

Ensure the `codemie-prod` realm is configured in Keycloak with:
- **"codemie" client scope** - custom scope for API access
- **"developer" role** - role for service accounts

### 3. Required Keycloak Objects

The script expects the following objects to exist in the `codemie-prod` realm:
- **Client Scope**: `codemie` - for API authorization
- **Realm Role**: `developer` - for service account permissions

## üéØ Functionality

The script manages API clients in the `codemie-prod` Keycloak realm:

For each client, the following operations are performed:
1. ‚úÖ Generate API client name with "api-" prefix
2. ‚úÖ Create new client or update existing one
3. ‚úÖ Assign "codemie" client scope for proper API authorization
4. ‚úÖ Assign "developer" role to the client's service account
5. ‚úÖ Update service account user details (email, first name, last name)
6. ‚úÖ Add "applications" and "applications_admin" attributes
7. ‚úÖ Display client credentials (Client ID and Secret)

## üöÄ Usage

### Creating or updating API client

```bash
python3 keycloak_api_client.py <project_name>
```

### Examples

```bash
# Creates client "api-codemie-project"
python3 keycloak_api_client.py codemie-project

# Creates client "api-test"
python3 keycloak_api_client.py test

# Updates existing client "api-my-service"
python3 keycloak_api_client.py my-service
```

## üìã Client Configuration Details

### Generated Client Settings:
- **Client ID**: `api-<project_name>`
- **Name**: `api-<project_name>`
- **Description**: `API client for <project_name>`
- **Client Authentication**: Enabled (confidential client)
- **Standard Flow**: Enabled
- **Direct Access Grants**: Enabled
- **Service Accounts**: Enabled
- **Root URL**: `<codemi_base_url>`
- **Valid Redirect URIs**: `<codemi_base_url>/*`
- **Access Token Lifespan**: `300` seconds

### Service Account Configuration:
- **Email**: `service-account-api-<project_name>@domain.com`
- **First Name**: `<first_part_of_project_name>`
- **Last Name**: `<second_part_of_project_name>`
- **Role**: `developer`
- **Attributes**:
  - `applications`: `<project_name>`
  - `applications_admin`: `<project_name>`

### Client Scopes:
- **Default Scopes**: `web-origins`, `role_list`, `profile`, `roles`, `email`, `codemie`
- **Optional Scopes**: `address`, `phone`, `offline_access`, `microprofile-jwt`

## üìã Example Results

### For project "codemie-project":

**Client Configuration:**
- **Client ID**: `api-codemie-project`
- **Client Secret**: `<auto-generated-secret>`
- **Service Accounts Enabled**: `true`
- **Assigned Scopes**: `codemie` (+ default scopes)

**Service Account User:**
- **Username**: `service-account-api-codemie-project`
- **Email**: `service-account-api-codemie-project@domain.com`
- **First Name**: `codemie`
- **Last Name**: `project`
- **Role**: `developer`
- **Attributes**:
  - `applications`: `codemie-project`
  - `applications_admin`: `codemie-project`

## ‚öôÔ∏è Configuration

Keycloak connection settings are located in the `keycloak_api_client.py` file:

```python
KEYCLOAK_CONFIG = {
    'keycloak_server_url': '',
    'codemie_realm': 'codemie-prod',
    'username': 'codemie_provisioner',
    'password': ''
}

# Additional settings
DEFAULT_ROOT_URL = "<codemi_base_url>"
DEFAULT_EMAIL_DOMAIN = "domain.com"
DEFAULT_ACCESS_TOKEN_LIFESPAN = "300"
```

**Important:** Set `keycloak_server_url` and `password` in script configuration before using.

## üîß Script Workflow

The script execution flow:

```
üöÄ Processing client 'api-codemie-project'...
‚úÖ Client 'api-codemie-project' successfully created!
‚úÖ Client scope 'codemie' successfully assigned!
‚úÖ Role 'developer' successfully assigned!
‚úÖ Service account user details updated!
   - Email: service-account-api-codemie-project@domain.com
   - First name: codemie
   - Last name: project
‚úÖ Service account user attributes updated!
   - applications: codemie-project
   - applications_admin: codemie-project
üìã Client Details:
   - Client ID: api-codemie-project
   - Client Secret: a1b2c3d4-e5f6-7890-abcd-ef1234567890
```

## üìÅ File Structure

- `keycloak_api_client.py` - Main script
- `README.md` - Documentation

## üõ°Ô∏è Security Features

- **Confidential Client**: Uses client authentication with secret
- **Service Account**: Dedicated service account for API access
- **Scoped Access**: Limited to "codemie" scope for API operations
- **Role-based Access**: "developer" role assigned to service account
- **Token Lifespan**: Configurable access token lifetime (default: 5 minutes)

## üö® Important Notes

1. **Ensure correct configuration** of Keycloak server URL and credentials
2. **Verify "codemie" scope exists** in the target realm before running
3. **Verify "developer" role exists** in the target realm before running
4. **Script is safe for re-runs** - existing clients are updated, not duplicated
5. **Client secrets are auto-generated** by Keycloak and displayed once

## üîÑ Update vs Create Behavior

- **New Client**: Creates client with full configuration
- **Existing Client**: Updates client configuration while preserving the existing secret
- **Service Account**: Always updates user details and attributes
- **Scopes & Roles**: Always re-assigns to ensure consistency

## üéØ Use Cases

This script is ideal for:
- **Microservices**: Creating API clients for service-to-service authentication
- **CI/CD Integration**: Automated client provisioning in deployment pipelines  
- **Development Teams**: Quick setup of API access for new projects
- **Infrastructure as Code**: Keycloak client configuration management